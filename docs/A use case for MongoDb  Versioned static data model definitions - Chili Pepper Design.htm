<!DOCTYPE html>
<!-- saved from url=(0086)http://chilipepperdesign.com/2013/11/11/versioned-data-model-definitions-with-mongodb/ -->
<html class="js video maskImage placeholder" lang="en"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <title>A use case for MongoDb: Versioned static data model definitions - Chili Pepper Design</title>
  <meta name="author" content="Evan Johnson">

  
  <meta name="description" content="">
  <meta name="keywords" content="mongodb,databases,data modelling,ORM,object relational mapping,entity attribute value,eav,document database,nosql">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
  <link rel="canonical" href="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design.htm">
  <link href="http://chilipepperdesign.com/favicon.png" rel="icon">
  <link href="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/cb=gapi.loaded_1" async=""></script><script src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/cb=gapi.loaded_0" async=""></script><script type="text/javascript" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/jXHR.js"></script><script type="text/javascript" async="" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/plusone.js" gapi_processed="true"></script><script id="facebook-jssdk" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/all.js"></script><script type="text/javascript" async="" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/ga.js"></script><script src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/modernizr-2.0.js"></script>
  <script src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/ender.js"></script>
  <script src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/octopress.js" type="text/javascript"></script>
  <link href="http://chilipepperdesign.com/atom.xml" rel="alternate" title="Chili Pepper Design" type="application/atom+xml">
  <link href="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/css" rel="stylesheet" type="text/css">
  <meta property="og:type" content="website">

    <meta property="og:url" content="http://chilipepperdesign.com/2013/11/11/versioned-data-model-definitions-with-mongodb/">
    <meta property="og:title" content="A use case for MongoDb: Versioned static data model definitions">


    
        <meta property="og:image" content="http://chilipepperdesign.com/square-logo.jpg">
    


    <meta property="og:description" content="">


<meta property="fb:app_id" content="171392359587743">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-6058373-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


<script type="text/javascript" async="" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/embed.js"></script><script type="text/javascript" async="" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/widgets.js"></script><style type="text/css">.fb_hidden{position:absolute;top:-10000px;z-index:10001}.fb_invisible{display:none}.fb_reset{background:none;border:0;border-spacing:0;color:#000;cursor:auto;direction:ltr;font-family:"lucida grande", tahoma, verdana, arial, sans-serif;font-size:11px;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal}.fb_reset>div{overflow:hidden}.fb_link img{border:none}
.fb_dialog{background:rgba(82, 82, 82, .7);position:absolute;top:-10000px;z-index:10001}.fb_reset .fb_dialog_legacy{overflow:visible}.fb_dialog_advanced{padding:10px;-moz-border-radius:8px;-webkit-border-radius:8px;border-radius:8px}.fb_dialog_content{background:#fff;color:#333}.fb_dialog_close_icon{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 0 transparent;_background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif);cursor:pointer;display:block;height:15px;position:absolute;right:18px;top:17px;width:15px}.fb_dialog_mobile .fb_dialog_close_icon{top:5px;left:5px;right:auto}.fb_dialog_padding{background-color:transparent;position:absolute;width:1px;z-index:-1}.fb_dialog_close_icon:hover{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -15px transparent;_background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif)}.fb_dialog_close_icon:active{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yq/r/IE9JII6Z1Ys.png) no-repeat scroll 0 -30px transparent;_background-image:url(http://static.ak.fbcdn.net/rsrc.php/v2/yL/r/s816eWC-2sl.gif)}.fb_dialog_loader{background-color:#f2f2f2;border:1px solid #606060;font-size:24px;padding:20px}.fb_dialog_top_left,.fb_dialog_top_right,.fb_dialog_bottom_left,.fb_dialog_bottom_right{height:10px;width:10px;overflow:hidden;position:absolute}.fb_dialog_top_left{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 0;left:-10px;top:-10px}.fb_dialog_top_right{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -10px;right:-10px;top:-10px}.fb_dialog_bottom_left{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -20px;bottom:-10px;left:-10px}.fb_dialog_bottom_right{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ye/r/8YeTNIlTZjm.png) no-repeat 0 -30px;right:-10px;bottom:-10px}.fb_dialog_vert_left,.fb_dialog_vert_right,.fb_dialog_horiz_top,.fb_dialog_horiz_bottom{position:absolute;background:#525252;filter:alpha(opacity=70);opacity:.7}.fb_dialog_vert_left,.fb_dialog_vert_right{width:10px;height:100%}.fb_dialog_vert_left{margin-left:-10px}.fb_dialog_vert_right{right:0;margin-right:-10px}.fb_dialog_horiz_top,.fb_dialog_horiz_bottom{width:100%;height:10px}.fb_dialog_horiz_top{margin-top:-10px}.fb_dialog_horiz_bottom{bottom:0;margin-bottom:-10px}.fb_dialog_iframe{line-height:0}.fb_dialog_content .dialog_title{background:#6d84b4;border:1px solid #3b5998;color:#fff;font-size:14px;font-weight:bold;margin:0}.fb_dialog_content .dialog_title>span{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/yd/r/Cou7n-nqK52.gif) no-repeat 5px 50%;float:left;padding:5px 0 7px 26px}body.fb_hidden{-webkit-transform:none;height:100%;margin:0;overflow:visible;position:absolute;top:-10000px;left:0;width:100%}.fb_dialog.fb_dialog_mobile.loading{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/ya/r/3rhSv5V8j3o.gif) white no-repeat 50% 50%;min-height:100%;min-width:100%;overflow:hidden;position:absolute;top:0;z-index:10001}.fb_dialog.fb_dialog_mobile.loading.centered{max-height:590px;min-height:590px;max-width:500px;min-width:500px}#fb-root #fb_dialog_ipad_overlay{background:rgba(0, 0, 0, .45);position:absolute;left:0;top:0;width:100%;min-height:100%;z-index:10000}#fb-root #fb_dialog_ipad_overlay.hidden{display:none}.fb_dialog.fb_dialog_mobile.loading iframe{visibility:hidden}.fb_dialog_content .dialog_header{-webkit-box-shadow:white 0 1px 1px -1px inset;background:-webkit-gradient(linear, 0% 0%, 0% 100%, from(#738ABA), to(#2C4987));border-bottom:1px solid;border-color:#1d4088;color:#fff;font:14px Helvetica, sans-serif;font-weight:bold;text-overflow:ellipsis;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0;vertical-align:middle;white-space:nowrap}.fb_dialog_content .dialog_header table{-webkit-font-smoothing:subpixel-antialiased;height:43px;width:100%}.fb_dialog_content .dialog_header td.header_left{font-size:12px;padding-left:5px;vertical-align:middle;width:60px}.fb_dialog_content .dialog_header td.header_right{font-size:12px;padding-right:5px;vertical-align:middle;width:60px}.fb_dialog_content .touchable_button{background:-webkit-gradient(linear, 0% 0%, 0% 100%, from(#4966A6), color-stop(.5, #355492), to(#2A4887));border:1px solid #29447e;-webkit-background-clip:padding-box;-webkit-border-radius:3px;-webkit-box-shadow:rgba(0, 0, 0, .117188) 0 1px 1px inset, rgba(255, 255, 255, .167969) 0 1px 0;display:inline-block;margin-top:3px;max-width:85px;line-height:18px;padding:4px 12px;position:relative}.fb_dialog_content .dialog_header .touchable_button input{border:none;background:none;color:#fff;font:12px Helvetica, sans-serif;font-weight:bold;margin:2px -12px;padding:2px 6px 3px 6px;text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog_content .dialog_header .header_center{color:#fff;font-size:16px;font-weight:bold;line-height:18px;text-align:center;vertical-align:middle}.fb_dialog_content .dialog_content{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/y9/r/jKEcVPZFk-2.gif) no-repeat 50% 50%;border:1px solid #555;border-bottom:0;border-top:0;height:150px}.fb_dialog_content .dialog_footer{background:#f2f2f2;border:1px solid #555;border-top-color:#ccc;height:40px}#fb_dialog_loader_close{float:left}.fb_dialog.fb_dialog_mobile .fb_dialog_close_button{text-shadow:rgba(0, 30, 84, .296875) 0 -1px 0}.fb_dialog.fb_dialog_mobile .fb_dialog_close_icon{visibility:hidden}
.fb_iframe_widget{display:inline-block;position:relative}.fb_iframe_widget span{display:inline-block;position:relative;text-align:justify}.fb_iframe_widget iframe{position:absolute}.fb_iframe_widget_lift{z-index:1}.fb_hide_iframes iframe{position:relative;left:-10000px}.fb_iframe_widget_loader{position:relative;display:inline-block}.fb_iframe_widget_fluid{display:inline}.fb_iframe_widget_fluid span{width:100%}.fb_iframe_widget_loader iframe{min-height:32px;z-index:2;zoom:1}.fb_iframe_widget_loader .FB_Loader{background:url(http://static.ak.fbcdn.net/rsrc.php/v2/y9/r/jKEcVPZFk-2.gif) no-repeat;height:32px;width:32px;margin-left:-16px;position:absolute;left:50%;z-index:4}
.fb_connect_bar_container div,.fb_connect_bar_container span,.fb_connect_bar_container a,.fb_connect_bar_container img,.fb_connect_bar_container strong{background:none;border-spacing:0;border:0;direction:ltr;font-style:normal;font-variant:normal;letter-spacing:normal;line-height:1;margin:0;overflow:visible;padding:0;text-align:left;text-decoration:none;text-indent:0;text-shadow:none;text-transform:none;visibility:visible;white-space:normal;word-spacing:normal;vertical-align:baseline}.fb_connect_bar_container{position:fixed;left:0 !important;right:0 !important;height:42px !important;padding:0 25px !important;margin:0 !important;vertical-align:middle !important;border-bottom:1px solid #333 !important;background:#3b5998 !important;z-index:99999999 !important;overflow:hidden !important}.fb_connect_bar_container_ie6{position:absolute;top:expression(document.compatMode=="CSS1Compat"? document.documentElement.scrollTop+"px":body.scrollTop+"px")}.fb_connect_bar{position:relative;margin:auto;height:100%;width:100%;padding:6px 0 0 0 !important;background:none;color:#fff !important;font-family:"lucida grande", tahoma, verdana, arial, sans-serif !important;font-size:13px !important;font-style:normal !important;font-variant:normal !important;font-weight:normal !important;letter-spacing:normal !important;line-height:1 !important;text-decoration:none !important;text-indent:0 !important;text-shadow:none !important;text-transform:none !important;white-space:normal !important;word-spacing:normal !important}.fb_connect_bar a:hover{color:#fff}.fb_connect_bar .fb_profile img{height:30px;width:30px;vertical-align:middle;margin:0 6px 5px 0}.fb_connect_bar div a,.fb_connect_bar span,.fb_connect_bar span a{color:#bac6da;font-size:11px;text-decoration:none}.fb_connect_bar .fb_buttons{float:right;margin-top:7px}
.fbpluginrecommendationsbarleft,.fbpluginrecommendationsbarright{position:fixed !important;bottom:0;z-index:999}.fbpluginrecommendationsbarleft{left:10px}.fbpluginrecommendationsbarright{right:10px}</style></head>

<body data-twttr-rendered="true">
  <header role="banner"><hgroup>
  <h1><a href="http://chilipepperdesign.com/">Chili Pepper Design</a></h1>
  
    <h2>Web development relleno</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://chilipepperdesign.com/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:chilipepperdesign.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search">
  </fieldset><fieldset class="mobile-nav"><select><option value="">Navigate…</option><option value="http://chilipepperdesign.com/projects">» Projects</option><option value="http://chilipepperdesign.com/archives">» Archives</option><option value="http://chilipepperdesign.com/atom.xml">» RSS</option></select></fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="http://chilipepperdesign.com/projects">Projects</a></li>
  <li><a href="http://chilipepperdesign.com/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">A Use Case for MongoDb: Versioned Static Data Model Definitions</h1>
    
    
      <p class="meta">
        








  


<time class="published updated" datetime="2013-11-11T13:53:00-07:00" pubdate="" data-updated="true">Nov 11<span>th</span>, 2013</time>
        
         | <a href="http://chilipepperdesign.com/2013/11/11/versioned-data-model-definitions-with-mongodb/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>At SplashLab, our CMS application supports custom web forms. Each form has a different set of fields which hold different types of data. Email addresses, multi-select radio buttons, text areas, etc. Some forms only get submitted a couple of times. Some are submitted many thousands of times. The best way to store this data is something we are still working on, but I thought I would share how we are using <a href="http://www.mongodb.org/">MongoDb</a> to solve this problem currently.</p>

<!-- more -->


<h2>Relational Database Solutions</h2>

<p>To store both the form definition and the submitted data in a normal relational database you either need many tables (one for each form), or you need to normalize your data schema, usually in the <a href="http://en.wikipedia.org/wiki/Entity%E2%80%93attribute%E2%80%93value_model">Entity-Attribute-Value</a> (EAV) style. (This is a common problem in ecommerce or other catalog applications, where products have arbitrary numbers and types of attributes.)</p>

<p>Creating many tables is not desirable. Constantly modifying your relational database schemas by adding new tables is a pain, takes a significant amount of extra application code (dynamic table names?), and can be difficult to manage thousands of tables on the RDBMS side. Another issue is that you have to alter existing tables if attributes are added or removed (or create another new table for this version of the form!), which could involve losing column data or adding lots of null values to rows.</p>

<p>EAV normalization is a hassle as well (<a href="http://magento.com/">Magento</a> anyone?). To review, this is where each data type (text, int, double, blob, etc) is stored in it’s own table. Text values are held in one table, integers in another table, etc, and all rows are keyed by the Attribute and Entity name they belong to. You need an ungodly number of joins to build the final object from the value tables. Inserting new objects requires breaking them apart and saving each value to the correct table. It’s also hard to view the data, since it’s spread out in multiple tables, making development and debugging more difficult.</p>

<h2>Document Database Solution</h2>

<p>Enter MongoDb. (Or another document database?) We store form definitions in one collection. Each document consists of the name of the form, and a sub-array of each attribute which includes it’s name, type, position, validation rules, etc. This form definition can be versioned, so if you update the form you can still decode old submission data. Creating another form (or another version of a form) involves simply inserting another document into the collection.</p>

<h3>Example Form Definition Collection</h3>

<figure class="code"><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
</pre></td><td class="code"><pre><code class=""><span class="line">{
</span><span class="line">  _id : ObjectId("xxxxx123"),  // Mongo Id
</span><span class="line">  label : "Form 1",
</span><span class="line">  name : "form1",  // unique, immutable id, enforced in app
</span><span class="line">  version : 1,
</span><span class="line">  fields: {
</span><span class="line">    0 : {
</span><span class="line">      name : "name",
</span><span class="line">      label : "Name",
</span><span class="line">      type : "text",
</span><span class="line">      length : 128,
</span><span class="line">      order : 0
</span><span class="line">    },
</span><span class="line">    1 : {
</span><span class="line">      name : "email",
</span><span class="line">      label : "Email",
</span><span class="line">      type : "email",
</span><span class="line">      length : 256,
</span><span class="line">      order : 1
</span><span class="line">    }
</span><span class="line">  }
</span><span class="line">},
</span><span class="line">{
</span><span class="line">  _id : ObjectId("xxxxx123"),
</span><span class="line">  label : "Form 2",
</span><span class="line">  name : "form2",
</span><span class="line">  version : 1,
</span><span class="line">  fields: {
</span><span class="line">    0 : {
</span><span class="line">      name : "name",
</span><span class="line">      label : "Name",
</span><span class="line">      type : "text",
</span><span class="line">      length : 128,
</span><span class="line">      order : 0
</span><span class="line">    },
</span><span class="line">    1 : {
</span><span class="line">      name : "color",
</span><span class="line">      label : "Favorite Color",
</span><span class="line">      type : "radio",
</span><span class="line">      options : {
</span><span class="line">        "red" : "Red",
</span><span class="line">        "green" : "Green",
</span><span class="line">        "blue" : "Blue"
</span><span class="line">      },
</span><span class="line">      order : 1
</span><span class="line">    },
</span><span class="line">    2 : {
</span><span class="line">      name : "state",
</span><span class="line">      label : "State",
</span><span class="line">      type : "us_states",
</span><span class="line">      order : 2
</span><span class="line">    }
</span><span class="line">  }
</span><span class="line">}</span></code></pre></td></tr></tbody></table></div></figure>


<p>Then we have a collection that holds all of the form submissions. Each submission is stored in a single document, with a sub-array of all of the data submitted for each field. No matter how different the data is it can all go in to one collection. But unlike a serialized field you can query the data (so long as you also include the form definition ID in the criteria).</p>

<h3>Example Form Submission Collection</h3>

<figure class="code"><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class=""><span class="line">{
</span><span class="line">  _id : ObjectId("xxxxx456"),
</span><span class="line">  form_name : "form1",
</span><span class="line">  form_version : 1,
</span><span class="line">  values: {
</span><span class="line">    name : "Testy McTesterson",
</span><span class="line">    email : "testy@test.com"
</span><span class="line">  }
</span><span class="line">},
</span><span class="line">{
</span><span class="line">  _id : ObjectId("yyyyy456"),
</span><span class="line">  form_name : "form2",
</span><span class="line">  form_version : 1,
</span><span class="line">  values: {
</span><span class="line">    name : "Tester Testopherson",
</span><span class="line">    color : "blue",
</span><span class="line">    state : "CA"
</span><span class="line">  }
</span><span class="line">}</span></code></pre></td></tr></tbody></table></div></figure>


<p>In theory, record insertion from form submits is simple. Generate the document from the form (including the form_name and form_version), and save it. Done. But if you need to do server-side validation it requires one database read to retrieve the form definition to get the validation rules.</p>

<p>The one piece of data that a form submission is tied to is the form definition, <em>but</em> these definitions should never be deleted or updated, making each form submission is atomic. In the worst case scenario the web form has already been generated when the form is updated to a new version. Then form is submitted. As long as the version number if submitted along with the form data the new submission will be associated with the old form, but should be no other issues. This means we don’t need transactions, which is something that rules out using MongoDb in other use cases.</p>

<p>Retrieval of form submissions is fairly efficient since only one extra read is required to get the form definition out of the database (for the presentation logic, so this is sort of optional actually…), then one more database read queries out all submissions that match that form’s name and version (be sure you have Indexed those fields!).</p>

<h2>Caveats and Drawbacks</h2>

<p>This works well since the form submissions are never going to be updated. They represent the data collected from the a specific form version, and should never have additional data added or removed. If you did need to update the submissions due to a change in the form definition, you would have to do a full scan of the collection and update each document. MongoDb supports multiple document updates, but it would be slow at “big data” scale (remember the <a href="http://stackoverflow.com/questions/17456671/to-what-level-does-mongodb-lock-on-writes-or-what-does-it-mean-by-per-connec">write-lock</a>!). But updates to a new version of the form should only affect <em>new</em> submissions, so this issue is avoided.</p>

<p>If you wanted to request <em>all</em> submissions, and <em>then</em> attempted to “JOIN” the form definitions for each one, it would be pretty awful - but that doesn’t really make sense to do. Generally you start with the form, and get the submissions for that form, not the other way around.</p>

<p>If you are enforcing unique value validation on individual forms, be sure that you have the proper Indexes set on the form_name field in the submission collection, so a <code>find()</code> command to assert that the new value is unique only scans through the submissions for that specific form. With all forms using the same collection, it will get large and indexing is important. If a single form has a huge number of entries it might be necessary to add another index just for that form’s unique field, but we have not run in to this yet.</p>

<p>One particularly tricky thing you may want to do is retrieve all of the data from multiple versions of a form, <em>which do not have exactly the same field definitions</em>. If you store the entries with the form ID and version, you can easily query them all by just omitting the version number (just like you would when checking for unique field values, etc). The challenge is displaying the data. Since we are not updating existing submissions to reflect form definition changes, some submissions will have missing fields or incorrect types. To handle this, we basically join all of the form’s version’s schemas together into a mega-schema, and make sure we have null checks and loose type coercions in our presentation code for the submissions. This is definitely more “art” (er, “hack”) than science.</p>

<p>One way to help with the issue above is to enforce form definition rules in the application code so that you can’t make a drastic change to a field definition, like to start using a text field called “first_name” to store a date. You could have a rule where you can’t change field definition types, perhaps, so you have to delete the “first_name” field and create a new “date” field, to avoid data type mis-matching. (Or you could just restrict queries to single form versions.)</p>

<p>Something else to watch out for is that if you lose a form definition (bad backup?), then the submission data for that form looses it’s meaning. Or if you accidentally modify the form definition for a version, the submissions for that version start to become incoherent (“What was ‘option1’ defined as in the form definition? How many options were there?”).</p>

<p>Finally (although I haven’t done a comparison), I assume this is not as space efficient as normalizing the data into a relational DB since you are duplicating the form name and version in each submission, as well as the field key names. Perhaps MongoDb handles this in some clever way, but I’m not aware of it.</p>

<h2>Conclusion</h2>

<p>You could still argue that it would be better to normalize this into a Entity-Attribute-Value style relational store with a de-normalized caching layer on top holding the final JOINed object. There are, after all, relations between each submission’s data values and the form’s definition. But this has been easier to develop, and so far we have not run in to any show stopping issues.</p>

<p>There are trade-offs with any ORM, and giant pitfalls to look out for whenever you have lots of dynamic schema data like this. Most of our application runs on SQL, but we plan to continue to use MongoDb for this component - at least until we don’t. ;)</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Evan Johnson</span></span>

      








  


<time class="published updated" datetime="2013-11-11T13:53:00-07:00" pubdate="" data-updated="true">Nov 11<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class="category" href="http://chilipepperdesign.com/categories/databases/">Databases</a>, <a class="category" href="http://chilipepperdesign.com/categories/mongodb/">MongoDB</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <iframe id="twitter-widget-0" scrolling="no" frameborder="0" allowtransparency="true" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/tweet_button.1401325387.htm" class="twitter-share-button twitter-tweet-button twitter-share-button twitter-count-horizontal" title="Twitter Tweet Button" data-twttr-rendered="true" style="width: 116px; height: 20px;"></iframe>
  
  
  <div id="___plusone_0" style="text-indent: 0px; margin: 0px; padding: 0px; background-color: transparent; border-style: none; float: none; line-height: normal; font-size: 1px; vertical-align: baseline; display: inline-block; width: 90px; height: 20px; background-position: initial initial; background-repeat: initial initial;"><iframe frameborder="0" hspace="0" marginheight="0" marginwidth="0" scrolling="no" style="position: static; top: 0px; width: 90px; margin: 0px; border-style: none; left: 0px; visibility: visible; height: 20px;" tabindex="0" vspace="0" width="100%" id="I0_1403072895074" name="I0_1403072895074" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/fastbutton.htm" data-gapiattached="true" title="+1"></iframe></div>
  
  
    <div class="fb-like fb_iframe_widget" data-send="true" data-width="450" data-show-faces="false" fb-xfbml-state="rendered" fb-iframe-plugin-query="app_id=212934732101925&amp;href=http%3A%2F%2Fchilipepperdesign.com%2F2013%2F11%2F11%2Fversioned-data-model-definitions-with-mongodb%2F&amp;locale=en_US&amp;sdk=joey&amp;send=true&amp;show_faces=false&amp;width=450"><span style="vertical-align: bottom; width: 450px; height: 20px;"><iframe name="f121cf2944" width="450px" height="1000px" frameborder="0" allowtransparency="true" scrolling="no" title="fb:like Facebook Social Plugin" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/like.htm" style="border: none; visibility: visible; width: 450px; height: 20px;" class=""></iframe></span></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="http://chilipepperdesign.com/2013/06/27/javascript-unit-testing-with-jamine-phantomjs-karma/" title="Previous Post: JavaScript unit testing with Jasmine, PhantomJs and Karma">« JavaScript unit testing with Jasmine, PhantomJs and Karma</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><iframe id="dsq-2" data-disqus-uid="2" allowtransparency="true" frameborder="0" tabindex="0" title="Disqus" width="100%" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/saved_resource.htm" style="width: 100% !important; border: none !important; overflow: hidden !important; height: 471px !important;" scrolling="no" horizontalscrolling="no" verticalscrolling="no"></iframe></div>
  </section>

</div>

<aside class="sidebar thirds">
  
    <section class="first odd">
    <h1>About Me</h1>
    <p><img id="profile-image" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/02bee2f91e0a8c3aefbfa6bfb5304c51" alt="Gravatar of thaddeusmt">My name is Evan Johnson. I'm a software developer from Montana, who spent some time in Nebraska. I'm the chief software architect at <a href="http://splashlabsocial.com/">SplashLab Social</a>, but I am blogging here on my old freelance web design URL for fun. I hope you find something useful here, thanks for visiting! Cheers</p>
    <p><a class="twitter-link" href="http://twitter.com/thaddeusmt" title="@thaddeusmt on Twitter"><img src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/twitter-bird-16x16.png"></a> <a class="googleplus-link" href="http://plus.google.com/115669497324630841356?prsrc=3" rel="author" title="Evan Johnson on Google+"><img src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/gplus-16.png" alt="Google+"></a></p>
</section><section class="even">
  <h1>Related Posts</h1>
  <ul id="related_posts">
    
      <li class="post">
        <a href="http://chilipepperdesign.com/2013/06/27/javascript-unit-testing-with-jamine-phantomjs-karma/">JavaScript unit testing with Jasmine, PhantomJs and Karma</a>
      </li>
    
      <li class="post">
        <a href="http://chilipepperdesign.com/2013/01/18/facebook-graph-search-facebook-page-optimization/">Facebook Page Optimization for Graph Search</a>
      </li>
    
      <li class="post">
        <a href="http://chilipepperdesign.com/2013/01/15/backbone-js-bind-callback-to-successful-model-fetch/">Backbone.js: Bind Callback to Successful Model Fetch</a>
      </li>
    
      <li class="post">
        <a href="http://chilipepperdesign.com/2013/01/07/deploying-code-with-git/">Deploying code with Git</a>
      </li>
    
      <li class="post">
        <a href="http://chilipepperdesign.com/2012/12/27/new-hipster-hacker-octopress-blog/">New Hipster Hacker Blog</a>
      </li>
    
  </ul>
</section>
<section class="odd">
  <h1>Categories</h1>
  <ul id="categories">
    <li class="category"><a href="http://chilipepperdesign.com/categories/apache/">Apache (1)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/backbone-js/">Backbone.js (1)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/css/">CSS (2)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/databases/">Databases (1)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/drupal/">Drupal (2)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/facebook/">Facebook (7)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/git/">Git (1)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/javascript/">JavaScript (5)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/linux/">Linux (3)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/magento/">Magento (11)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/meta/">Meta (5)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/mongodb/">MongoDB (1)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/nginx/">Nginx (3)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/reviews/">Reviews (1)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/ruby/">Ruby (1)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/seo/">SEO (3)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/sysadmin/">Sysadmin (4)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/wordpress/">WordPress (3)</a></li>
<li class="category"><a href="http://chilipepperdesign.com/categories/jquery/">jQuery (2)</a></li>

  </ul>
</section>
<section class="first even">
  <h1>Latest Tweets</h1>
    <p data-twttr-id="twttr-sandbox-0">
    
    <iframe id="twitter-widget-1" scrolling="no" frameborder="0" allowtransparency="true" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/follow_button.1401325387.htm" class="twitter-follow-button twitter-follow-button" title="Twitter Follow Button" data-twttr-rendered="true" style="width: 143px; height: 20px;"></iframe>
    
    <iframe id="twitter-widget-2" scrolling="no" frameborder="0" allowtransparency="true" class="twitter-timeline twitter-timeline-rendered" style="border: none; max-width: 100%; min-width: 180px; width: 260px;" title="Twitter Timeline" height="300"></iframe>
    </p>
</section>

<section class="odd">
  <h1>StackOverflow</h1>
  <a id="stackoverflow-badge" href="http://stackoverflow.com/users/164439/thaddeusmt"><img src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/164439.png" width="208" height="58" alt="profile for thaddeusmt at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for thaddeusmt at Stack Overflow, Q&amp;A for professional and enthusiast programmers"></a>
</section>
<section class="even">
  <h1>Coderwall</h1>
  <ul id="cw_badges"><a class="cw_badge" title="Have a project valued enough to be forked by someone else" href="http://coderwall.com/thaddeusmt"><img alt="Have a project valued enough to be forked by someone else" height="65" width="65" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/forked1-23f567ca38fbd180fb706c72e85af0a3.png"></a><a class="cw_badge" title="Have at least one original repo where Ruby is the dominant language" href="http://coderwall.com/thaddeusmt"><img alt="Have at least one original repo where Ruby is the dominant language" height="65" width="65" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/mongoose-667f1d46e4cce51e9615c62fa2521fd7.png"></a><a class="cw_badge" title="Have at least one original repos where PHP is the dominant language" href="http://coderwall.com/thaddeusmt"><img alt="Have at least one original repos where PHP is the dominant language" height="65" width="65" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/nephilakomaci-c32b356912ea0f42e8f039dab9ce7eba.png"></a><a class="cw_badge" title="The walrus is no stranger to variety. Use at least 4 different languages throughout all your repos" href="http://coderwall.com/thaddeusmt"><img alt="The walrus is no stranger to variety. Use at least 4 different languages throughout all your repos" height="65" width="65" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/walrus-c03d2be90a246fdfe2785263ba0d2689.png"></a><a class="cw_badge" title="Fork and commit to someone&#39;s open source project in need" href="http://coderwall.com/thaddeusmt"><img alt="Fork and commit to someone&#39;s open source project in need" height="65" width="65" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/charity-9dbeb4fe6b8461b146d8abfad0ec723b.png"></a><a class="cw_badge" title="Have at least one original jQuery or Prototype open source repo" href="http://coderwall.com/thaddeusmt"><img alt="Have at least one original jQuery or Prototype open source repo" height="65" width="65" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/cub-60dc199f764db25d10c34c8ac11fc6e2.png"></a></ul>

  <script type="text/javascript">
    var coderwall = (function(){
      function render(options, badges){
        var fragment = '',
            t = $(options.target)[0],
            height = 65,
            width = 65,
            index;

        for (index in badges) {
          fragment += '<a class="cw_badge"title="' + badges[index].description + '" href="http://coderwall.com/' + options.user + '">';
          fragment +=   '<img alt="' + badges[index].description + '" height="' + width + '" width="' + height + '" src="' + badges[index].badge + '"/>';
          fragment += '</a>';
        }

        t.innerHTML = fragment;
      }
      return {
        showBadges: function(options){
          $.ajax({
              url: 'http://coderwall.com/' + options.user + '.json?callback=?'
            , type: 'jsonp'
            , error: function (err) { $(options.target + ' li.loading').addClass('error').text("Error loading feed"); }
            , success: function(res) {
                render(options, res.data.badges);
            }
          });
        }
      };
    })();

    $.domReady(function(){
      if (!window.jXHR){
        var jxhr = document.createElement('script');
        jxhr.type = 'text/javascript';
        jxhr.src = '/javascripts/libs/jXHR.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(jxhr, s);
      }
      if (!window.$){
        var b = document.createElement('script');
        b.type = 'text/javascript';
        b.src = '/javascripts/ender.js';
        var sc = document.getElementsByTagName('script')[0];
        sc.parentNode.insertBefore(jxhr, s);
      }
      coderwall.showBadges({
        user: 'thaddeusmt',
        target: '#cw_badges'
      });
    });
  </script>
  <style type="text/css">
    .cw_badge img {
      padding: 5px;
      border: 0 none !important;
      -moz-box-shadow: none !important;
      -webkit-box-shadow: none !important;
      -o-box-shadow: none !important;
      box-shadow: none !important;
    }
  </style>
</section>


  
</aside>


    <span class="toggle-sidebar"></span></div>
  </div>
  <footer role="contentinfo"><p>
  Copyright © 2014 - Evan Johnson -
  <span class="credit">Powered by <a href="http://octopress.org/">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'chilipepperdesign';
      
        
              // var disqus_developer = 1;
        
           var disqus_identifier = 'http://www.chilipepperdesign.com/2013/11/11/versioned-data-model-definitions-with-mongodb/';
        

        var disqus_url = 'http://www.chilipepperdesign.com/2013/11/11/versioned-data-model-definitions-with-mongodb/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root" class=" fb_reset"><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div><iframe name="fb_xdm_frame_http" frameborder="0" allowtransparency="true" scrolling="no" id="fb_xdm_frame_http" aria-hidden="true" title="Facebook Cross Domain Communication Frame" tabindex="-1" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/V80PAcvrynR.htm" style="border: none;"></iframe><iframe name="fb_xdm_frame_https" frameborder="0" allowtransparency="true" scrolling="no" id="fb_xdm_frame_https" aria-hidden="true" title="Facebook Cross Domain Communication Frame" tabindex="-1" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/V80PAcvrynR(1).htm" style="border: none;"></iframe></div></div><div style="position: absolute; top: -10000px; height: 0px; width: 0px;"><div><iframe name="f30c0f292" frameborder="0" allowtransparency="true" scrolling="no" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/ping.htm" style="display: none;"></iframe></div></div></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>







<iframe id="rufous-sandbox" scrolling="no" frameborder="0" allowtransparency="true" style="display: none;"></iframe><iframe name="oauth2relay575299989" id="oauth2relay575299989" src="./A use case for MongoDb  Versioned static data model definitions - Chili Pepper Design_files/postmessageRelay.htm" tabindex="-1" style="width: 1px; height: 1px; position: absolute; top: -100px;"></iframe></body></html>